#!/usr/local/bin/konoha

/*
 * doc.k : switch index html
 * copyright (c) chen_ji 2011
 */

using konoha.cookie.*;
include "login.k";
if (not defined INCLUDE_STORAGE) {
	include "storage.k";
}

string html = ##<!DOCTYPE html>
              ##<html lang="ja">
              ##	<head>
              ##		<meta charset="UTF-8">
              ##		<title>Aspen - An online KonohaScript editor</title>
              ##
              ##		<!-- for IE compatibility -->
              ##		<!--[if lt IE 9]>
              ##		<script src="http://ie7-js.googlecode.com/svn/version/2.1(beta4)/IE9.js"></script>
              ##		<![endif]-->
              ##
              ##		<!-- codemirror -->
              ##		<script src="%pjs/codemirror.js"></script>
              ##		<script src="%pjs/autocompletion.js"></script>
              ##		<link rel="stylesheet" href="%pcss/codemirror.css">
              ##
              ##		<!-- syntax highlight -->
              ##		<script src="%pjs/konoha.js"></script>
              ##		<link rel="stylesheet" href="%pcss/konoha.css">
              ##
              ##		<!-- mootools -->
              ##		<script src="%pjs/mootools-core-1.3.2-full-compat.js"></script>
              ##		<script src="%pjs/mootools-more-1.3.2.1.js"></script>
              ##
              ##		<!-- shadowbox -->
              ##		<script src="%plib/shadowbox-3.0.3/shadowbox.js"></script>
              ##		<link rel="stylesheet" href="%plib/shadowbox-3.0.3/shadowbox.css">
              ##
              ##		<!-- tab pane -->
              ##		<script src="%pjs/TabPane.js"></script>
              ##
              ##		<!-- aspen -->
              ##		<script src="%pjs/aspen.js"></script>
              ##		<link rel="stylesheet" href="%pcss/aspen.css">
              ##	</head>
              ##	<body>
              ##		<!-- header menu -->
              ##		<header>
              ##			<div id="topmenu_l">
              ##				<div class="menubutton"><a id="new" href="#new">New</a></div>
              ##				<div class="menubutton"><a id="open" href="#open">Open</a></div>
              ##				<div class="menubutton"><a id="save" href="#save">Save</a></div>
              ##				<div class="menubutton"><a id="eval" href="#run">Run</a></div>
              ##			</div>
              ##			<div id="topmenu_r">
              ##				<img src="http://img.tweetimag.es/i/%user_m" alt="%user"
              ##				align="top" />
              ##				<div class="userinfo" id="user">%user</div>
              ##				<div class="menubutton"><a id="sign_out" href="#signout">Sign
              ##				out</a></div>
              ##			</div>
              ##		</header>
              ##
              ##		<!-- result -->
              ##		<div id="result">
              ##			<span class="message"></span>
              ##		</div>
              ##
              ##		<!-- editor body -->
              ##		<div id="tabpane">
              ##			<ul id="tabs" class="tabs">
              ##			</ul>
              ##		</div>
              ##	</body>
              ##</html>

void redirect()
{
	LoginManager manager = new LoginManager();
	Map<string,string> token = manager.getRequestToken();
	manager.saveRequestCookie(token);
	manager.redirectToProvider(token["oauth_token"]);
}

void main()
{
	string[] args = ($env.PATH_INFO).split("/");
	if (|args| <= 1) {
		OUT << "Location: ./doc/\n" << EOL;
		return;
	}
	Cookie cookie = new Cookie($env.HTTP_COOKIE);
	if (cookie["SID"] != null) {
		Storage storage = new Storage();
		string name = storage.getScreenName(cookie["SID"]["val"]);
		if (name != "") {
			OUT << "Content-Type: text/html\n" << EOL;
			OUT << html.replace($/%p/g, BASE_URL).replace($/%user/g, name) << EOL;
		} else {
			string past = "Thu, 01 Jan 1970 00:00:00 GMT";
			cookie["SID"]["expires"] = past;
			cookie["SID"]["path"] = "/";
			OUT << cookie.dump();
			redirect();
		}
	} else {
		//OUT << "Content-Type: text/html\n" << EOL;
		//print "ERROR!!";
		//print cookie;
		redirect();
	}
}
